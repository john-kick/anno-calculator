<!DOCTYPE html>
<head>
  <title>Demand Calculator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #4caf50;
      color: white;
    }
    .section {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #f9f9f9;
    }
    .section h3 {
      margin-top: 0;
    }
  </style>
</head>
<body>
  <form>
    <div>
      <label for="farmer">Farmer</label>
      <input id="farmer" name="farmer" type="number" value="0" />
    </div>
    <div>
      <label for="worker">Worker</label>
      <input id="worker" name="worker" type="number" value="0" />
    </div>
    <div>
      <label for="engineer">Engineer</label>
      <input id="engineer" name="engineer" type="number" value="0" />
    </div>
    <div>
      <label for="artisan">Artisan</label>
      <input id="artisan" name="artisan" type="number" value="0" />
    </div>
    <div>
      <label for="investor">Investor</label>
      <input id="investor" name="investor" type="number" value="0" />
    </div>
    <button type="submit">Submit</button>
  </form>

  <div id="results"></div>

  <script type="text/javascript">
    const form = document.querySelector("form");
    const resultsContainer = document.getElementById("results");

    form.onsubmit = async (event) => {
      event.preventDefault();

      const formData = new FormData(form);
      const formDataObject = Object.fromEntries(formData.entries());

      try {
        const response = await fetch("/calculate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(formDataObject)
        });

        if (!response.ok) {
          throw new Error(`Error: ${response.statusText}`);
        }

        const data = await response.json();
        displayResults(data);
      } catch (error) {
        console.error("Error submitting form:", error);
        resultsContainer.innerHTML = `<div class="section"><strong>Error:</strong> ${error.message}</div>`;
      }
    };

    function createTable(headers, rows) {
      const table = document.createElement("table");

      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");

      headers.forEach((header) => {
        const th = document.createElement("th");
        th.textContent = header;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      rows.forEach((row) => {
        const tr = document.createElement("tr");
        row.forEach((cell) => {
          const td = document.createElement("td");
          td.textContent = cell;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);

      return table;
    }

    function displayResults(data) {
      resultsContainer.innerHTML = "";

      // Overall Demand
      const demandRows = Object.entries(data.overallDemand).map(
        ([product, amount]) => [product, amount.toFixed(2)]
      );
      const demandSection = document.createElement("div");
      demandSection.className = "section";
      demandSection.innerHTML = `<h3>Overall Demand</h3>`;
      demandSection.appendChild(createTable(["Product", "Amount"], demandRows));
      resultsContainer.appendChild(demandSection);

      // Needed Productions
      const productionRows = data.neededProductions.map(
        ({ production, amount }) => [
          production.product,
          amount.toFixed(2),
          production.workerType,
          production.workerAmount
        ]
      );
      const productionSection = document.createElement("div");
      productionSection.className = "section";
      productionSection.innerHTML = `<h3>Needed Productions</h3>`;
      productionSection.appendChild(
        createTable(
          ["Product", "Amount", "Worker Type", "Worker Amount"],
          productionRows
        )
      );
      resultsContainer.appendChild(productionSection);

      // Combined Workers
      const combinedWorkerRows = Object.entries(data.neededWorker).map(
        ([workerType, amount]) => [
          workerType,
          amount.toFixed(2),
          data.freeWorker[workerType].toFixed(2)
        ]
      );
      const workerSection = document.createElement("div");
      workerSection.className = "section";
      workerSection.innerHTML = `<h3>Workers Overview</h3>`;
      workerSection.appendChild(
        createTable(["Worker Type", "Needed", "Free"], combinedWorkerRows)
      );
      resultsContainer.appendChild(workerSection);
    }
  </script>
</body>
